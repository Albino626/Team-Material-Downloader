# 远程服务器部署指南

本指南介绍如何在远程服务器上部署团队素材下载工具，支持 **Linux** 和 **Windows** 服务器。

## 📋 服务器信息

- **服务器IP**: `<您的服务器IP>`
- **操作系统**: Linux / Windows Server / Windows 10/11
- **下载目录**: 自动创建或自定义路径
- **服务端口**: 3000（可配置）
- **默认密码**: 321123 ⚠️ **首次登录后请立即修改！**

## 🐳 方式一：Docker 部署（推荐）

Docker 部署是最简单的方式，适用于所有操作系统。

### Linux 服务器

```bash
# 1. 安装 Docker 和 Docker Compose
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 2. 克隆或上传项目
git clone <repository-url>
cd material-downloader

# 3. 启动服务
docker-compose up -d

# 4. 查看日志
docker-compose logs -f
```

### Windows 服务器

1. **安装 Docker Desktop**
   - 下载：https://www.docker.com/products/docker-desktop
   - 安装并重启

2. **启动服务**
   ```powershell
   # 进入项目目录
   cd material-downloader
   
   # 启动服务
   docker-compose up -d
   
   # 查看日志
   docker-compose logs -f
   ```

详细说明请查看：[DOCKER.md](../DOCKER.md)

## 🚀 方式二：传统部署步骤

### Linux 服务器部署

#### 1. 安装Node.js

使用包管理器安装 Node.js（版本 >= 14.0.0）：

**Ubuntu/Debian**:
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs
```

**CentOS/RHEL**:
```bash
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs
```

**验证安装**:
```bash
node --version
npm --version
```

#### 2. 上传项目文件

将整个 `server` 文件夹上传到服务器，例如：
```bash
/home/user/material-downloader/server/
├── package.json
├── server-browser.js
└── parsers/
    ├── base.js
    ├── yuansu.js
    ├── 90sheji.js
    └── design006.js
```

#### 3. 安装依赖

```bash
cd /home/user/material-downloader/server
npm install
```

#### 4. 配置防火墙

```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 3000/tcp
sudo ufw reload

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

#### 5. 启动服务器

**使用 PM2（推荐）**:
```bash
# 安装 PM2
npm install -g pm2

# 启动服务
pm2 start server-browser.js --name material-downloader

# 设置开机自启
pm2 startup
pm2 save
```

**手动启动**:
```bash
cd /home/user/material-downloader/server
node server-browser.js
```

**使用 systemd 服务**:
创建 `/etc/systemd/system/material-downloader.service`:
```ini
[Unit]
Description=Material Downloader Server
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/home/user/material-downloader/server
ExecStart=/usr/bin/node server-browser.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:
```bash
sudo systemctl enable material-downloader
sudo systemctl start material-downloader
sudo systemctl status material-downloader
```

### Windows 服务器部署

#### 1. 安装Node.js

在Windows服务器上安装Node.js（版本 >= 14.0.0）

**下载地址**: https://nodejs.org/

**验证安装**:
```cmd
node --version
npm --version
```

#### 2. 上传项目文件

将整个 `server` 文件夹上传到服务器任意目录，例如：
```
C:\Users\Administrator\Desktop\server\  (推荐)
或
D:\Projects\team-material-downloader\server\
├── package.json
├── server-browser.js
├── 启动服务器.bat
├── start.bat
├── install.bat
└── parsers\
    ├── base.js
    ├── yuansu.js
    ├── 90sheji.js
    └── design006.js
```

#### 3. 安装依赖

在服务器上打开PowerShell或CMD，进入server目录：

```cmd
cd C:\Users\Administrator\Desktop\server
npm install
```

这将安装以下依赖：
- express
- cors
- puppeteer
- axios

### 4. 配置防火墙

**开放端口3000**，允许外网访问：

```powershell
# PowerShell命令
New-NetFirewallRule -DisplayName "团队素材下载工具" -Direction Inbound -LocalPort 3000 -Protocol TCP -Action Allow
```

或通过图形界面：
1. 打开 Windows Defender 防火墙
2. 高级设置 → 入站规则 → 新建规则
3. 端口 → TCP → 特定本地端口：3000
4. 允许连接

### 5. 启动服务器

**方法一：双击启动脚本**
```
双击 启动服务器.bat
```

**方法二：命令行启动**
```cmd
cd C:\Users\Administrator\Desktop\server
node server-browser.js
```

### 6. 验证服务器

服务器启动后，您应该看到：

```
═══════════════════════════════════════
✅ 服务器已启动
═══════════════════════════════════════
🌐 监听地址: 0.0.0.0:3000
📁 下载目录: C:\Users\Administrator\Desktop\server\Downloads

💡 访问地址:
   • 本地: http://localhost:3000
   • 远程: http://<您的服务器IP>:3000

📌 已打开四个独立浏览器窗口：
   • 窗口1：花瓣网 (https://huaban.com)
   • 窗口2：觅元素 (https://www.51yuansu.com/)
   • 窗口3：90设计 (https://90sheji.com/)
   • 窗口4：享设计 (https://www.design006.com/)
```

## 👥 客户端配置

### 在uTools插件中配置服务器地址

1. 打开插件，进入"管理员"标签
2. 输入默认密码：`321123` ⚠️ **首次登录后请立即修改！**
3. 在"系统设置"中修改服务器地址：
   ```
   本地部署: http://localhost:3000
   远程部署: http://<您的服务器IP>:3000
   ```
4. 点击"保存配置"
5. **重要**：点击"修改密码"更改默认密码

## 🔄 设置开机自动启动

### 方法一：创建Windows服务（推荐）

使用 `nssm` (Non-Sucking Service Manager)

1. **下载nssm**: https://nssm.cc/download
2. **安装服务**:
   ```cmd
   nssm install TeamMaterialDownloader "C:\Program Files\nodejs\node.exe" "C:\Users\Administrator\Desktop\server\server-browser.js"
   nssm set TeamMaterialDownloader AppDirectory "C:\Users\Administrator\Desktop\server"
   nssm start TeamMaterialDownloader
   ```

### 方法二：任务计划程序

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：计算机启动时
4. 操作：启动程序
   - 程序：`node.exe`
   - 参数：`server-browser.js`
   - 起始位置：`C:\Users\Administrator\Desktop\server`

### 方法三：启动文件夹（简单）

将 `启动服务器.bat` 的快捷方式放到：
```
C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
```

## 📊 监控和维护

### 检查服务器状态

访问健康检查端点：
```
本地: http://localhost:3000/api/health
远程: http://<您的服务器IP>:3000/api/health
```

返回示例：
```json
{
  "status": "ok",
  "isLoggedIn": false
}
```

### 查看日志

服务器会在控制台输出详细日志，包括：
- 登录状态
- 下载操作
- 错误信息
- 自动清理任务

### 自动清理

Downloads文件夹会每12小时自动清理一次，清理日志示例：

```
═══════════════════════════════════════
🗑️  自动清理下载文件夹
═══════════════════════════════════════
⏰ 清理时间: 2025-10-27 02:30:45
📊 清理文件数: 15
📁 文件夹: C:\Users\Administrator\Desktop\server\Downloads
═══════════════════════════════════════
```

## ⚠️ 注意事项

### 1. 端口占用
确保3000端口未被其他程序占用：
```cmd
netstat -ano | findstr :3000
```

### 2. 浏览器资源
Puppeteer会启动4个Chromium浏览器实例，确保服务器内存充足（建议4GB+）

### 3. 网络连接
确保服务器可以访问：
- huaban.com
- 51yuansu.com
- 90sheji.com
- design006.com

### 4. 磁盘空间
定期检查Downloads文件夹大小，虽然有自动清理，但高峰期可能需要更多空间

## 🔧 环境变量配置（可选）

可以通过环境变量自定义配置：

```cmd
# 设置端口
set PORT=8080

# 设置监听地址
set HOST=0.0.0.0

# 设置下载目录
set DOWNLOADS_PATH=D:\Downloads

# 启动服务器
node server-browser.js
```

## 🔐 密码管理

### 默认密码
- **默认密码**: 321123
- **重要**: 首次登录后必须立即修改！

### 修改密码
1. 登录管理员面板（密码：321123）
2. 进入"系统设置"
3. 点击"修改密码"
4. 按提示输入当前密码和新密码

### 忘记密码
如果忘记密码，可以：
1. 在管理员面板的"系统设置"中
2. 点击"重置密码"
3. 密码将恢复为默认值：321123

### 安全建议
- 使用强密码（包含字母、数字、符号）
- 定期更换密码
- 不要与他人分享管理员密码
- 密码保存在浏览器本地存储中

## 🛠️ 故障排查

### 问题1: 无法访问服务器
- 检查防火墙是否开放3000端口
- 检查服务器是否正常运行
- ping <服务器IP> 测试网络连接

### 问题2: 浏览器启动失败
- 确保安装了所有依赖：`npm install`
- 检查是否有足够的内存
- 查看错误日志

### 问题3: 下载失败
- 检查对应网站的登录状态
- 查看服务器控制台日志
- 确认网络连接正常

### 问题4: 服务意外停止
- 使用Windows服务方式运行（推荐）
- 查看事件查看器中的应用程序日志

## 📱 技术支持

如遇到问题：
1. 查看服务器控制台日志
2. 检查 README.md 中的常见问题
3. 确认所有配置正确

---

**部署完成后，记得在客户端配置服务器地址：http://<您的服务器IP>:3000**

